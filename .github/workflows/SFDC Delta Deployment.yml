name: Deploy to Sandbox

on:
  push:
    branches:
      - feature/*

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # 1. Checkout code
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 0    # IMPORTANT for SGD to read git history

      # 2. Install Node + SGD
      - name: Install Node
        uses: actions/setup-node@v3
        with:
          node-version: "18"

      - name: Install SFDX-git-delta
        run: npm install -g sfdx-git-delta

      # 3. Install Salesforce CLI
      - name: Install Salesforce CLI
        uses: salesforcecli/action-sf-install@v1

      # 4. Authenticate to Salesforce (Sandbox)
      - name: Authenticate Sandbox
        run: |
          echo "${{ secrets.SF_SANDBOX_JWT }}" > server.key
          sf org login jwt \
            --username ${{ secrets.SF_SANDBOX_USERNAME }} \
            --keyfile server.key \
            --client-id ${{ secrets.SF_CLIENT_ID }} \
            --instance-url https://test.salesforce.com

      # 5. Generate delta
      - name: Generate Delta
        run: |
          sgd delta --from main --to HEAD --output delta

      # 6. Deploy delta to Salesforce
      - name: Deploy to Sandbox
        run: |
          sf project deploy start --source delta --json
